


<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    
    <title>Advanced tricks &mdash; Pooch v1.3.0</title>
    


  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/style.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.png"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Downloaders" href="downloaders.html" />
    <link rel="prev" title="Intermediate tricks" href="intermediate.html" />
    <!-- Plausible analytics for anonymous usage statistics -->
    <script defer data-domain="fatiando.org" src="https://plausible.io/js/plausible.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html">
          

          
            
            <img src="_static/pooch-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                v1.3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="retrieve.html">Retrieving a data file</a></li>
<li class="toctree-l1"><a class="reference internal" href="citing.html">Citing Pooch</a></li>
</ul>
<p class="caption"><span class="caption-text">Training your Pooch</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="beginner.html">Beginner tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="intermediate.html">Intermediate tricks</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Advanced tricks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#adjusting-the-logging-level">Adjusting the logging level</a></li>
<li class="toctree-l2"><a class="reference internal" href="#retry-failed-downloads">Retry failed downloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bypassing-the-hash-check">Bypassing the hash check</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-registry-file-from-remote-files">Create registry file from remote files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="downloaders.html">Downloaders</a></li>
<li class="toctree-l1"><a class="reference internal" href="processors.html">Processors</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html">Changelog</a></li>
</ul>

            
          

    
        <p class="caption">
            <span class="caption-text">
            
                Getting help and contributing
            
            </span>
        </p>
        <ul>
            
                <li class="toctree-l1"><a href="https://www.fatiando.org"><i class="fa fa-external-link-square fa-fw"></i> Fatiando a Terra</a></li>
            
                <li class="toctree-l1"><a href="https://github.com/fatiando/pooch/blob/master/CONTRIBUTING.md"><i class="fa fa-users fa-fw"></i> Contributing</a></li>
            
                <li class="toctree-l1"><a href="https://github.com/fatiando/pooch/blob/master/CODE_OF_CONDUCT.md"><i class="fa fa-gavel fa-fw"></i> Code of Conduct</a></li>
            
                <li class="toctree-l1"><a href="http://contact.fatiando.org"><i class="fa fa-comment fa-fw"></i> Contact</a></li>
            
                <li class="toctree-l1"><a href="https://github.com/fatiando/pooch"><i class="fa fa-github fa-fw"></i> Source Code</a></li>
            
        </ul>
    

        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Pooch</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          
















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Advanced tricks</li>
    
    
    <li class="source-link">
        
            
                <a href="https://github.com/fatiando/pooch/edit/master/doc/advanced.rst"
                   class="fa fa-github"> Improve this page</a>
            
        
        
    </li>

  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="advanced-tricks">
<span id="advanced"></span><h1>Advanced tricks<a class="headerlink" href="#advanced-tricks" title="Permalink to this headline">¶</a></h1>
<p>These are more advanced things that can be done for specific use cases. <strong>Most
projects will not require these</strong>.</p>
<div class="section" id="adjusting-the-logging-level">
<h2>Adjusting the logging level<a class="headerlink" href="#adjusting-the-logging-level" title="Permalink to this headline">¶</a></h2>
<p>Pooch will log events like downloading a new file, updating an existing one, or
unpacking an archive by printing to the terminal. You can change how verbose
these events are by getting the event logger from pooch and changing the
logging level:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span> <span class="o">=</span> <span class="n">pooch</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Most of the events from Pooch are logged at the info level; this code says that
you only care about warnings or errors, like inability to create the data
cache. The event logger is a <a class="reference external" href="https://docs.python.org/3/library/logging.html#logging.Logger" title="(in Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">logging.Logger</span></code></a> object, so you can use
that class’s methods to handle logging events in more sophisticated ways if you
wish.</p>
</div>
<div class="section" id="retry-failed-downloads">
<h2>Retry failed downloads<a class="headerlink" href="#retry-failed-downloads" title="Permalink to this headline">¶</a></h2>
<p>When downloading data repeatedly, like in continuous integration, failures can
occur due to sporadic network outages or other factors outside of our control.
In these cases, it can be frustrating to have entire jobs fail because a single
download was not successful.</p>
<p>Pooch allows you to specify a number of times to retry the download in case of
failure by setting <code class="docutils literal notranslate"><span class="pre">retry_if_failed</span></code> in <a class="reference internal" href="api/generated/pooch.create.html#pooch.create" title="pooch.create"><code class="xref py py-func docutils literal notranslate"><span class="pre">pooch.create</span></code></a>. This setting
will be valid for all downloads attempted with <a class="reference internal" href="api/generated/pooch.Pooch.html#pooch.Pooch.fetch" title="pooch.Pooch.fetch"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pooch.Pooch.fetch</span></code></a>. The
download can fail because the file hash doesn’t match the known hash (due to a
partial download, for example) or because of network errors coming from
<a class="reference external" href="https://3.python-requests.org/api/#module-requests" title="(in Requests v2.21.0)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">requests</span></code></a>. Other errors (file system permission errors, etc) will still
result in a failed download.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Requires Pooch &gt;= 1.3.0.</p>
</div>
</div>
<div class="section" id="bypassing-the-hash-check">
<h2>Bypassing the hash check<a class="headerlink" href="#bypassing-the-hash-check" title="Permalink to this headline">¶</a></h2>
<p>Sometimes we might not know the hash of the file or it could change on the
server periodically. In these cases, we need a way of bypassing the hash check.
One way of doing that is with Python’s <code class="docutils literal notranslate"><span class="pre">unittest.mock</span></code> module. It defines the
object <code class="docutils literal notranslate"><span class="pre">unittest.mock.ANY</span></code> which passes all equality tests made against it.
To bypass the check, we can set the hash value to <code class="docutils literal notranslate"><span class="pre">unittest.mock.ANY</span></code> when
specifying the <code class="docutils literal notranslate"><span class="pre">registry</span></code> argument for <a class="reference internal" href="api/generated/pooch.create.html#pooch.create" title="pooch.create"><code class="xref py py-func docutils literal notranslate"><span class="pre">pooch.create</span></code></a>.</p>
<p>In this example, we want to use Pooch to download a list of weather stations
around Australia. The file with the stations is in an FTP server and we want to
store it locally in separate folders for each day that the code is run. The
problem is that the <code class="docutils literal notranslate"><span class="pre">stations.zip</span></code> file is updated on the server instead of
creating a new one, so the hash check would fail. This is how you can solve
this problem:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">unittest.mock</span>
<span class="kn">import</span> <span class="nn">pooch</span>

<span class="c1"># Get the current data to store the files in separate folders</span>
<span class="n">CURRENT_DATE</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

<span class="n">GOODBOY</span> <span class="o">=</span> <span class="n">pooch</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">path</span><span class="o">=</span><span class="n">pooch</span><span class="o">.</span><span class="n">os_cache</span><span class="p">(</span><span class="s2">&quot;bom_daily_stations&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">CURRENT_DATE</span><span class="p">,</span>
    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;ftp://ftp.bom.gov.au/anon2/home/ncc/metadata/sitelists/&quot;</span><span class="p">,</span>
    <span class="c1"># Use ANY for the hash value to ignore the checks</span>
    <span class="n">registry</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;stations.zip&quot;</span><span class="p">:</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Because hash check is always <code class="docutils literal notranslate"><span class="pre">True</span></code>, Pooch will only download the file once.
When running again at a different date, the file will be downloaded again
because the local cache folder changed and the file is no longer present in it.
If you omit <code class="docutils literal notranslate"><span class="pre">CURRENT_DATE</span></code> from the cache path, then Pooch will only fetch
the files once, unless they are deleted from the cache.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If this script is run over a period of time, your cache directory will
increase in size, as the files are stored in daily subdirectories.</p>
</div>
</div>
<div class="section" id="create-registry-file-from-remote-files">
<h2>Create registry file from remote files<a class="headerlink" href="#create-registry-file-from-remote-files" title="Permalink to this headline">¶</a></h2>
<p>If you want to create a registry file for a large number of data files that are
available for download but you don’t have their hashes or any local copies,
you must download them first. Manually downloading each file
can be tedious. However, we can automate the process using
<a class="reference internal" href="api/generated/pooch.retrieve.html#pooch.retrieve" title="pooch.retrieve"><code class="xref py py-func docutils literal notranslate"><span class="pre">pooch.retrieve</span></code></a>. Below, we’ll explore two different scenarios.</p>
<p>If the data files share the same base url, we can use <a class="reference internal" href="api/generated/pooch.retrieve.html#pooch.retrieve" title="pooch.retrieve"><code class="xref py py-func docutils literal notranslate"><span class="pre">pooch.retrieve</span></code></a>
to download them and then use <a class="reference internal" href="api/generated/pooch.make_registry.html#pooch.make_registry" title="pooch.make_registry"><code class="xref py py-func docutils literal notranslate"><span class="pre">pooch.make_registry</span></code></a> to create the
registry:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Names of the data files</span>
<span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c137.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;cronen.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;citadel.csv&quot;</span><span class="p">]</span>

<span class="c1"># Base url from which the data files can be downloaded from</span>
<span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://www.some-data-hosting-site.com/files/&quot;</span>

<span class="c1"># Create a new directory where all files will be downloaded</span>
<span class="n">directory</span> <span class="o">=</span> <span class="s2">&quot;data_files&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

<span class="c1"># Download each data file to data_files</span>
<span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">pooch</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="n">base_url</span> <span class="o">+</span> <span class="n">fname</span><span class="p">,</span> <span class="n">known_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">directory</span>
    <span class="p">)</span>

<span class="c1"># Create the registry file from the downloaded data files</span>
<span class="n">pooch</span><span class="o">.</span><span class="n">make_registry</span><span class="p">(</span><span class="s2">&quot;data_files&quot;</span><span class="p">,</span> <span class="s2">&quot;registry.txt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If each data file has its own url, the registry file can be manually created
after downloading each data file through <a class="reference internal" href="api/generated/pooch.retrieve.html#pooch.retrieve" title="pooch.retrieve"><code class="xref py py-func docutils literal notranslate"><span class="pre">pooch.retrieve</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Names and urls of the data files. The file names are used for naming the</span>
<span class="c1"># downloaded files. These are the names that will be included in the registry.</span>
<span class="n">fnames_and_urls</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;c137.csv&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.some-data-hosting-site.com/c137/data.csv&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cronen.csv&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.some-data-hosting-site.com/cronen/data.csv&quot;</span><span class="p">,</span>
    <span class="s2">&quot;citadel.csv&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.some-data-hosting-site.com/citadel/data.csv&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Create a new directory where all files will be downloaded</span>
<span class="n">directory</span> <span class="o">=</span> <span class="s2">&quot;data_files&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

<span class="c1"># Create a new registry file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;registry.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">registry</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">fnames_and_urls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Download each data file to the specified directory</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pooch</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">known_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">directory</span>
        <span class="p">)</span>
        <span class="c1"># Add the name, hash, and url of the file to the new registry file</span>
        <span class="n">registry</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pooch</span><span class="o">.</span><span class="n">file_hash</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Notice that there are <strong>no checks for download integrity</strong> (since we don’t
know the file hashes before hand). Only do this for trusted data sources
and over a secure connection. If you have access to file hashes/checksums,
<strong>we highly recommend using them</strong> to set the <code class="docutils literal notranslate"><span class="pre">known_hash</span></code> argument.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="downloaders.html" class="btn btn-neutral float-right" title="Downloaders" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="intermediate.html" class="btn btn-neutral float-left" title="Intermediate tricks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2018-2020, The Pooch Developers.
      <span class="lastupdated">
        Last updated on Nov 27, 2020.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>